---
import Layout from '../layouts/Layout.astro';
import ProposalDeck from '../components/ProposalDeck.astro';
import errorData from '../data/errors.json';
import layoffData from '../data/layoffs.json';
import saasData from '../data/saas.json';
import llcData from '../data/llc.json';

// 1. Determine Identity
const siteId = import.meta.env.SITE_ID || 'errors';

// 2. Select Data Source
let rawData;
if (siteId === 'layoffs') rawData = layoffData;
else if (siteId === 'saas') rawData = saasData;
else if (siteId === 'llc') rawData = llcData;
else rawData = errorData;

// 3. THE FIX: Filter the data BEFORE using it
// This removes any "ghost" records causing the crash
const cleanData = rawData.filter((item) => {
  return item && typeof item.slug === 'string' && item.slug.trim().length > 0;
});

// 4. Config variables
let title, subtitle, placeholder, theme;

if (siteId === 'layoffs') {
    title = "ErrorCodeHelp";
    subtitle = "OBD2 & System Error Database";
    placeholder = "Search OBD2 codes (e.g. P0300)...";
    theme = "bg-indigo-600";
} else if (siteId === 'saas') {
    title = "SaaS Battleground";
    subtitle = "Unbiased B2B Software Comparisons";
    placeholder = "Search comparisons (e.g. HubSpot vs Salesforce)...";
    theme = "bg-purple-900";
} else if (siteId === 'llc') {
    title = "StateFiling";
    subtitle = "2025 LLC Filing Costs & Requirements";
    placeholder = "Search states (e.g. Texas, California)...";
    theme = "bg-slate-800";
} else {
    title = "RepairHelper";
    subtitle = "Find Replacement Parts & Fixes Fast";
    placeholder = "Search error codes (e.g. F01, Samsung)...";
    theme = "bg-blue-600";
}

// 0. SPECIAL CASE: Proposal Deck
// If this is the "The New Answer" site, we render the deck immediately.
// We do NOT use the main Layout to avoid the "Search Bar" appearing.
// This ensures a distraction-free, high-end presentation mode.
---

{
  siteId === 'proposal' ? (
    <html lang="en">
      <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>The New Answer</title>
        <meta name="description" content="Scaling Infinity Digital: Executive Brief" />
      </head>
      <body class="bg-slate-950 text-slate-300 font-sans antialiased selection:bg-blue-500 selection:text-white">
        <ProposalDeck />
      </body>
    </html>
  ) : (
    <Layout title={title} meta={subtitle}>
      <div class={`w-full py-24 ${theme} text-white text-center`}>
        <h1 class="text-5xl font-bold">{title}</h1>
        <p class="mt-4 text-xl opacity-90">{subtitle}</p>
        
        <div class="max-w-xl mx-auto mt-8 px-4">
          <input 
            type="text" 
            id="search-input"
            placeholder={placeholder}
            class="w-full p-4 rounded-lg text-gray-900 shadow-lg outline-none focus:ring-4 ring-opacity-50"
          />
        </div>
      </div>

      <div class="max-w-6xl mx-auto mt-12 px-6">
        <h2 class="text-2xl font-bold mb-6 text-center">Latest Updates</h2>
        
        <div id="card-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {cleanData.slice(0, 100).map((item) => (
            <a href={`/${item.slug.toLowerCase()}`} class="search-card block p-6 border rounded-lg hover:shadow-md transition bg-white group">
              <h3 class="font-bold text-lg group-hover:text-blue-600">
                {item.brand}
              </h3>
              <p class="text-2xl font-bold mt-2 text-gray-800">
                {item.code || item.title}
              </p>
              <span class="text-sm text-gray-500 mt-2 block">
                 Click to view details &rarr;
              </span>
              <span class="hidden search-term">{item.slug} {item.brand} {item.code} {item.title}</span>
            </a>
          ))}
        </div>
      </div>

      <script>
        const searchInput = document.getElementById('search-input');
        const cards = document.querySelectorAll('.search-card');

        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            cards.forEach((card) => {
              const content = card.querySelector('.search-term').innerText.toLowerCase();
              if (content.includes(term)) {
                card.classList.remove('hidden');
              } else {
                card.classList.add('hidden');
              }
            });
          });
        }
      </script>
    </Layout>
  )
}

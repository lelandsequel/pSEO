---
import Layout from '../layouts/Layout.astro';
import errorData from '../data/errors.json';
import layoffData from '../data/layoffs.json';

// 1. Determine Identity
const siteId = import.meta.env.SITE_ID || 'errors';
const isLayoffSite = siteId === 'layoffs';

// 2. Select Data Source
const rawData = isLayoffSite ? layoffData : errorData;

// 3. THE FIX: Filter the data BEFORE using it
// This removes any "ghost" records causing the crash
const cleanData = rawData.filter((item) => {
  return item && typeof item.slug === 'string' && item.slug.trim().length > 0;
});

// 4. Config variables
const title = isLayoffSite ? "ErrorCodeHelp" : "RepairHelper";
const subtitle = isLayoffSite ? "OBD2 & System Error Database" : "Find Replacement Parts & Fixes Fast";
const placeholder = isLayoffSite ? "Search OBD2 codes (e.g. P0300)..." : "Search error codes (e.g. F01, Samsung)...";
const theme = isLayoffSite ? "bg-indigo-600" : "bg-blue-600";
---

<Layout title={title} meta={subtitle}>
  <div class={`w-full py-24 ${theme} text-white text-center`}>
    <h1 class="text-5xl font-bold">{title}</h1>
    <p class="mt-4 text-xl opacity-90">{subtitle}</p>
    
    <div class="max-w-xl mx-auto mt-8 px-4">
      <input 
        type="text" 
        id="search-input"
        placeholder={placeholder}
        class="w-full p-4 rounded-lg text-gray-900 shadow-lg outline-none focus:ring-4 ring-opacity-50"
      />
    </div>
  </div>

  <div class="max-w-6xl mx-auto mt-12 px-6">
    <h2 class="text-2xl font-bold mb-6 text-center">Latest Updates</h2>
    
    <div id="card-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {cleanData.slice(0, 100).map((item) => (
        <a href={`/${item.slug.toLowerCase()}`} class="search-card block p-6 border rounded-lg hover:shadow-md transition bg-white group">
          <h3 class="font-bold text-lg group-hover:text-blue-600">
            {item.brand}
          </h3>
          <p class="text-2xl font-bold mt-2 text-gray-800">
            {item.code || item.title}
          </p>
          <span class="text-sm text-gray-500 mt-2 block">
             Click to view details &rarr;
          </span>
          <span class="hidden search-term">{item.slug} {item.brand} {item.code} {item.title}</span>
        </a>
      ))}
    </div>
  </div>

  <script>
    const searchInput = document.getElementById('search-input');
    const cards = document.querySelectorAll('.search-card');

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        cards.forEach((card) => {
          const content = card.querySelector('.search-term').innerText.toLowerCase();
          if (content.includes(term)) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });
      });
    }
  </script>
</Layout>
